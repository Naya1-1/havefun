<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>å“¥ç‰¹å¬å”¤æœ¯å¼ Â· Arcana Obscura</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=UnifrakturCook:wght@700&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b10;
    --ink:#e6dccb;
    --accent:#a31419;     /* ä¸»è‰²ï¼šéšé˜µå‹åˆ‡æ¢ */
    --accent-2:#4a0a0f;   /* æ¬¡è‰²ï¼šéšé˜µå‹åˆ‡æ¢ */
    --glow: #f03c3c;
    --rune: #c7bba3;
    --panel:#0d0d12;
    --panel-ink:#b9b2a5;
    --muted:#6a645a;
    --good:#64d2a3;
    --warn:#d2a364;
    --bad:#e07b7b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);overflow:hidden;color:var(--ink);font-family: "Cinzel","IM Fell English SC",serif;cursor:none}
  /* èƒŒæ™¯ï¼šæ·±é‚ƒæ”¾å°„+æš—çº¹å™ªç‚¹+æ¸å˜é›¾ */
  body:before{
    content:"";
    position:fixed;inset:0;
    background:
      radial-gradient(1200px 1200px at 50% 48%, rgba(90,40,40,.20), transparent 60%),
      radial-gradient(900px 900px at 50% 52%, rgba(40,60,90,.15), transparent 65%),
      radial-gradient(1200px 900px at 50% -10%, rgba(255,255,210,.06), transparent 60%),
      conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.02), rgba(0,0,0,.02));
    mix-blend-mode:screen;pointer-events:none;z-index:0;
  }
  body:after{
    content:"";
    position:fixed;inset:0;
    background-image:url("data:image/svg+xml;utf8,\
      <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>\
      <filter id='n'><feTurbulence baseFrequency='.9' numOctaves='1' seed='7'/><feComponentTransfer>\
      <feFuncR type='discrete' tableValues='0 1'/><feFuncG type='discrete' tableValues='0 1'/>\
      <feFuncB type='discrete' tableValues='0 1'/></feComponentTransfer></filter>\
      <rect width='120' height='120' filter='url(%23n)' opacity='.028'/>\
      </svg>");
    opacity:.6;pointer-events:none;z-index:0;
  }

  .app{
    display:grid;grid-template-columns: 320px 1fr;
    grid-template-rows:auto 1fr; gap:0;
    height:100%;position:relative;z-index:1;
  }
  @media(max-width: 1000px){
    .app{grid-template-columns:1fr;grid-template-rows: auto auto 1fr}
  }

  /* å¬å”¤é˜µåŒºåŸŸ */
  .stage{
    position:relative;display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  .stage .canvas-wrap{position:absolute;inset:0;pointer-events:none}
  #particles{position:absolute;inset:0}
  .circle-wrap{
    position:relative;width:min(90vmin,900px);height:min(90vmin,900px);
    filter: drop-shadow(0 0 10px rgba(220,170,120,.06)) drop-shadow(0 0 24px rgba(220,170,120,.04));
  }
  svg#circle{width:100%;height:100%;display:block;overflow:visible}
  .glow{filter:url(#glow)}
  .softglow{filter:url(#softglow)}
  .runes text{font-family:"UnifrakturCook","IM Fell English SC",serif;letter-spacing:.06em}
  .runes .ringtext{fill:var(--rune);opacity:.9}
  .runes .ringtext.alt{opacity:.4}
  .spin-slow{animation:spin 120s linear infinite}
  .spin-mid{animation:spin 48s linear infinite}
  .spin-fast{animation:spin 12s linear infinite}
  .pulse{animation:pulse 3s ease-in-out infinite}
  .flicker{animation:flicker 4s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes pulse{
    0%,100%{opacity:.85}
    50%{opacity:1; filter: drop-shadow(0 0 12px var(--glow))}
  }
  @keyframes flicker{
    0%, 19%, 21%, 23%, 80%, 100%{ opacity:.9 }
    20%, 22%, 24%{ opacity:.65 }
    55%{ opacity:.78 }
  }

  /* æ‰è½ç›®æ ‡ï¼ˆé˜µå¿ƒï¼‰ */
  .drop-target{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:180px;height:180px;border-radius:50%;
    border:1px dashed rgba(220,210,180,.18);
    box-shadow: inset 0 0 24px rgba(240,210,180,.06);
    transition:all .25s ease;
    /* pointer-events:none; <-- This was the problem */
  }
  .drop-target.active{
    border-color:var(--ink);
    box-shadow: inset 0 0 30px rgba(250,230,200,.18), 0 0 30px rgba(250,230,200,.12);
    transform:translate(-50%,-50%) scale(1.06);
  }

  /* é¡¶éƒ¨ï¼šé˜µå‹åˆ‡æ¢ */
  .topbar{
    grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:linear-gradient(to right, rgba(20,20,28,.85), rgba(12,12,16,.6));
    border-bottom:1px solid rgba(200,190,160,.1);
  }
  .brand{display:flex;gap:10px;align-items:baseline}
  .brand h1{font-family:"IM Fell English SC",serif; font-size:20px; letter-spacing:.2em; margin:0;color:var(--ink)}
  .switcher{display:flex; gap:10px}
  .sigil-btn{
    position:relative;display:flex;flex-direction:column;align-items:center;gap:4px;
    min-width:96px;padding:8px 10px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.04));
    border:1px solid rgba(220,210,190,.14); color:var(--panel-ink); text-align:center; cursor:pointer;
    transition:all .25s ease; user-select:none
  }
  .sigil-btn .icon{font-size:20px; line-height:1}
  .sigil-btn small{font-family:"IM Fell English SC",serif;letter-spacing:.1em;color:var(--muted)}
  .sigil-btn.active{color:var(--ink);border-color:var(--ink); box-shadow:inset 0 0 20px rgba(255,230,200,.06), 0 0 12px rgba(255,230,200,.04)}
  .sigil-btn:hover{transform:translateY(-1px)}
  /* ç¥­å“é¢æ¿ */
  .panel{
    background: radial-gradient(800px 400px at 10% 0%, rgba(120,90,50,.08), transparent 60%), var(--panel);
    border-right:1px solid rgba(200,190,160,.12);
    padding:12px 12px 8px 12px; position:relative;
  }
  .panel h2{font-size:16px; letter-spacing:.2em; margin:4px 2px 12px;color:var(--ink)}
  .rules{font-family:"IM Fell English SC"; font-size:13px;color:var(--muted);line-height:1.2;margin-bottom:10px}
  .offer-list{
    display:grid;grid-template-columns:repeat(2, 1fr); gap:8px; max-height:calc(100vh - 210px);
    overflow:auto; padding-right:4px; scrollbar-width:thin;
  }
  .offer{
    border:1px solid rgba(220,210,180,.14);
    padding:8px; min-height:60px; display:flex; gap:10px; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.05));
    transition:all .2s ease; user-select:none
  }
  .offer .sym{
    width:36px;height:36px;border:1px solid rgba(220,210,180,.2);display:flex;align-items:center;justify-content:center;
    font-size:20px; font-family:"UnifrakturCook","Cinzel"; color:var(--ink); background: rgba(255,255,255,.02);
  }
  .offer .txt{display:flex;flex-direction:column;line-height:1.1}
  .offer b{font-size:12px}
  .offer small{font-size:11px;color:var(--muted)}
  .offer[draggable="true"]{cursor:grab}
  .offer:active{cursor:grabbing}
  .offer:hover{transform:translateY(-1px); border-color:rgba(250,240,210,.25)}
  .panel .footer{
    margin-top:8px;display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px
  }
  .chips{display:flex; gap:6px;flex-wrap:wrap;padding:8px 2px}
  .chip{border:1px dashed rgba(220,210,180,.2); padding:4px 8px; font-size:12px;color:var(--panel-ink); background:rgba(255,255,255,.03)}
  .progress{font-family:"IM Fell English SC"; letter-spacing:.2em}
  @media(max-width: 1000px){
    .panel{order:2; border-right:none; border-top:1px solid rgba(200,190,160,.12)}
    .offer-list{grid-template-columns:repeat(5,1fr); max-height:none}
  }

  /* æç¤ºä¸æ•…äº‹Modal */
  .toast{
    position:fixed; left:50%; top:6%; transform:translateX(-50%);
    padding:6px 12px; background:rgba(20,20,26,.84); border:1px solid rgba(220,210,180,.2);
    color:var(--panel-ink); font-size:13px; z-index:50; pointer-events:none
  }
  .summon-overlay{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:30;
    background: radial-gradient(circle at 50% 50%, rgba(20,8,8,.9), rgba(0,0,0,.94) 60%, rgba(0,0,0,.98));
    animation:fadein .35s ease both;
  }
  @keyframes fadein{from{opacity:0}to{opacity:1}}
  .summon-card{
    width:min(860px, 92vw); border:1px solid rgba(255,240,200,.24);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.06)); padding:20px;
    box-shadow:0 0 40px rgba(200,160,120,.1), inset 0 0 80px rgba(255,230,200,.04);
    position:relative; overflow:hidden;
  }
  .summon-card h3{font-size:26px;margin:0 0 10px}
  .summon-card p{font-size:14px; line-height:1.6; color:#d6d1c7}
  .summon-card .name{font-family:"IM Fell English SC";letter-spacing:.2em}
  .card-glow{position:absolute; inset:-2px; pointer-events:none; border:1px solid rgba(250,230,210,.08)}
  .close-hint{position:absolute; right:12px; top:8px; font-size:12px; color:var(--muted)}

  /* å…‰æ ‡ç³»ç»Ÿ */
  .cursor-dot,.cursor-ring{
    position:fixed; left:0; top:0; pointer-events:none; z-index:60; mix-blend-mode:screen
  }
  .cursor-dot{width:6px;height:6px;border-radius:50%;background:radial-gradient(circle, #fff, var(--glow))}
  .cursor-ring{width:24px;height:24px;border-radius:50%; border:1px solid rgba(250,240,220,.35);box-shadow:0 0 12px rgba(250,220,190,.1) inset}
  .rune-tail{
    position:fixed; font-family:"UnifrakturCook"; font-size:16px;color:var(--ink); opacity:.85; pointer-events:none;
    text-shadow:0 0 6px var(--glow);
    animation:tailfade .8s ease-out forwards;
  }
  @keyframes tailfade{
    0%{opacity:1; transform:translateY(0) scale(1)}
    100%{opacity:0; transform:translateY(-16px) scale(0.9)}
  }

  /* å¬å”¤å†²å‡»æ³¢/ç«ç„°/è½å¶/æ˜Ÿå°˜ç­‰æ•ˆæœå®¹å™¨ */
  .fx-layer{position:absolute; inset:0; pointer-events:none}
  .shockwave{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:80px; height:80px; border-radius:50%; border:1px solid rgba(255,230,200,.7);
    box-shadow:0 0 10px rgba(255,230,200,.5);
    animation:shock .9s ease-out forwards;
  }
  @keyframes shock{
    from{opacity:1; transform:translate(-50%,-50%) scale(.6)}
    to{opacity:0; transform:translate(-50%,-50%) scale(6)}
  }
  .ember,.leaf,.stardust,.shadow-mote,.bubble{
    position:absolute; width:4px; height:4px; border-radius:50%; opacity:.9
  }

  /* SVGæ»¤é•œ */
  svg#circle defs + g {}
</style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="brand">
      <h1>ARCANA OBSCURA</h1>
      <div class="rules">æ‹–å…¥ä»»æ„ä¸‰ä»¶ç¥­å“åˆ°é˜µå¿ƒå”¤èµ·å¼‚ç•Œæ¥å®¢ã€‚å¯åˆ‡æ¢æ ¸å¿ƒæ³•é˜µï¼Œæ”¹å˜å¬å”¤è°±ç³»ã€‚</div>
    </div>
    <div class="switcher">
      <div class="sigil-btn active" data-core="infernal" title="åœ°ç‹±æ³•é˜µÂ·Infernum">
        <div class="icon">âœ </div>
        <small>INFERNUM</small>
      </div>
      <div class="sigil-btn" data-core="sylvan" title="å¯†æ—æ³•é˜µÂ·Sylva">
        <div class="icon">âœ½</div>
        <small>SYLVA</small>
      </div>
      <div class="sigil-btn" data-core="astral" title="æ˜Ÿç•Œæ³•é˜µÂ·Astra">
        <div class="icon">âœ¶</div>
        <small>ASTRA</small>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>ç¥­å“é€‰å•</h2>
    <div class="rules">æ¯æ¬¡éšæœº 10 ä»¶ï¼Œæ‹–æ‹½ç¬¦å·è‡³é˜µå¿ƒã€‚é€‰å®š 3 ä»¶å³åˆ»å‘åŠ¨ã€‚</div>
    <div class="offer-list" id="offerList"></div>
    <div class="chips" id="chips"></div>
    <div class="footer">
      <div class="progress" id="progress">å·²é€‰ 0 / 3</div>
    </div>
  </div>

  <div class="stage">
    <div class="canvas-wrap">
      <canvas id="particles"></canvas>
    </div>
    <div class="circle-wrap">
      <svg id="circle" viewBox="-480 -480 960 960" aria-label="summoning-circle">
        <defs>
          <filter id="glow">
            <feGaussianBlur stdDeviation="2" result="B"/>
            <feMerge><feMergeNode in="B"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <filter id="softglow">
            <feGaussianBlur stdDeviation="1.5" result="B"/>
            <feMerge><feMergeNode in="B"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <radialGradient id="gold" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#f6e7c1"/><stop offset="100%" stop-color="#8a6b3e"/>
          </radialGradient>
          <linearGradient id="scarlet" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#7a1016"/><stop offset="100%" stop-color="#30090c"/>
          </linearGradient>
          <path id="runePathOuter" d="M 0 -360 A 360 360 0 1 1 -0.01 -360 Z"/>
          <path id="runePathInner" d="M 0 -280 A 280 280 0 1 1 -0.01 -280 Z"/>
        </defs>

        <g id="designs"></g>

        <g class="runes spin-mid" style="mix-blend-mode:screen">
          <text class="ringtext" font-size="28">
            <textPath href="#runePathOuter" startOffset="0%">
              áš áš¢áš¦áš¨áš± áš²áš·áš¹ášº áš¾á›á›ƒá›‡ á›ˆá›‰á›Šá› á›’á›–á›—á›š á›œ â€” á›« á›¬ á›­ á›® á›¯ á›° â€” áš áš¢áš¦áš¨áš± áš²áš·áš¹ášº áš¾á›á›ƒá›‡ á›ˆá›‰á›Šá› á›’á›–á›—á›š á›œ
            </textPath>
          </text>
          <text class="ringtext alt" font-size="18">
            <textPath href="#runePathInner" startOffset="50%">
              â™„ â˜¿ â™ƒ â™€ â™‚ â˜‰ â˜½ âŠ• âœ¢ âœ£ âœ§ âœ¶ âœ· âœ¹ âœº âœµ âœ¦ âœ´ âœ¸ âœ¹ âœ¶ âœ· âœ¸ âœ´ âœ¦ âœ¢ âœ£
            </textPath>
          </text>
        </g>
      </svg>

      <div class="fx-layer" id="fxLayer"></div>
      <div class="drop-target" id="dropTarget"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast" style="display:none;"></div>

<div class="summon-overlay" id="summonOverlay" role="dialog" aria-modal="true">
  <div class="summon-card">
    <div class="close-hint">æ•°ç§’åè‡ªåŠ¨é‡ç½®</div>
    <div class="card-glow"></div>
    <h3><span class="name" id="summonTitle"></span></h3>
    <p id="summonStory"></p>
  </div>
</div>

<div class="cursor-dot" id="cDot"></div>
<div class="cursor-ring" id="cRing"></div>

<script>
;(() => {
  /* å…¨å±€çŠ¶æ€ */
  const state = {
    core: 'infernal',      // å½“å‰é˜µå‹ infernal/sylvan/astral
    selected: [],          // å·²æŠ•ç¥­å“ id
    pool: [],              // å½“å‰é¢æ¿éšæœº10
    offerings: [],         // å…¨é‡ç¥­å“è¡¨
  };

  /* é…è‰²é›† */
  const themes = {
    infernal: {accent:'#a31419', accent2:'#3e0a0f', glow:'#ff3a2f'},
    sylvan:   {accent:'#267a54', accent2:'#0f3a2a', glow:'#66e0b1'},
    astral:   {accent:'#4b5f9e', accent2:'#1a203a', glow:'#8aa8ff'},
  };

  /* åˆå§‹åŒ–ç¬¦å·ç¥­å“ï¼ˆâ‰¥60ï¼‰ */
  const O = (id,name,symbol,tags)=>({id,name,symbol,tags});
  state.offerings = [
    // è¡€å½±/å†¥æ¸Š
    O('vial_blood','è¡€ä¹‹å°ç“¶','ğŸœ‡',['blood','dark','ritual']),
    O('bone_dust','éª¨ç°æœ«','âœ¶',['death','earth','dark']),
    O('grave_soil','å¢“åœŸ','âœ´',['earth','death','dark']),
    O('raven_quill','æ¸¡é¸¦ç¾½','âœ¢',['air','omen','shadow']),
    O('nightshade','æ›¼é™€ç½—ç§','âœ§',['herb','poison','shadow']),
    O('obsidian','é»‘æ›œç¢ç‰‡','â—‡',['earth','shadow','fire']),
    O('bat_wing','è ç¿¼è†œ','â‹„',['air','night','shadow']),
    O('iron_nail','é“é’‰','âŠ—',['iron','order','earth']),
    O('black_candle','é»‘çƒ›','âœ ',['ritual','dark','fire']),
    O('mirror_shard','é•œä¹‹ç¢ç‰‡','â—',['mirror','illusion','moon']),

    // æ˜Ÿè¾‰/é“¶è¾‰
    O('moonstone','æœˆé•¿çŸ³','â˜½',['moon','silver','astral']),
    O('starchart','æ˜Ÿå›¾çº¸','âœ¹',['star','astral','order']),
    O('meteor_iron','é™¨é“å±‘','â›’',['iron','star','astral']),
    O('silver_dust','é“¶å±‘','â˜¾',['silver','purify','moon']),
    O('aurora_thread','æå…‰ä¸','â‹†',['light','air','astral']),
    O('aether_quartz','ä»¥å¤ªæ™¶','âœµ',['aether','astral','order']),
    O('comet_salt','å½—æ˜Ÿç›','âœ²',['salt','star','astral']),
    O('hourglass_grain','æ²™æ¼æœ«ç ‚','âŒ›',['time','order','earth']),
    O('astral_ink','æ˜Ÿè¾‰å¢¨','âœ’',['astral','ritual','script']),
    O('runic_chalk','ç¬¦æ–‡ç™½å©','â¨',['script','earth','ritual']),

    // æ—æµ·/å¤æœ¨
    O('oak_leaf','æ©¡å¶','â§',['wood','nature','life']),
    O('mistletoe','æ§²å¯„ç”Ÿ','âœ¿',['herb','nature','light']),
    O('mandrake','æ›¼å¾·æ‹‰è‰æ ¹','âš˜',['herb','earth','life']),
    O('wolfsbane','ç‹¼æ¯’','âœ¥',['herb','beast','moon']),
    O('moss','å¤è‹”','â–',['earth','nature','water']),
    O('lotus','è²ç“£','âœ½',['water','lotus','life']),
    O('amber','ç¥ç€','â—ˆ',['amber','sun','ancient']),
    O('pine_resin','æ¾è„‚','âœ¤',['resin','fire','nature']),
    O('rose_thorn','è”·è–‡åˆº','âœ£',['thorn','life','blood']),
    O('leaf_scroll','å¶çº¹å·','âŸ†',['script','nature','order']),

    // å…ƒç´ /ç‚¼é‡‘
    O('sulfur','ç¡«ç£º','ğŸœ',['sulfur','fire','alch']),
    O('mercury','æ°´é“¶','â˜¿',['mercury','fluid','alch']),
    O('sea_salt','æµ·ç›','ğŸœ”',['salt','water','purify']),
    O('spring_water','æ³‰æ°´','ğŸœ„',['water','life','purify']),
    O('coal','ç…¤å±‘','ğŸœ‚',['fire','earth','dark']),
    O('tektite','é›·åŒ–ç»ç’ƒ','â–³',['storm','fire','glass']),
    O('storm_sand','é£æš´ç ‚','âˆ¿',['air','storm','chaos']),
    O('cinder','ç°çƒ¬','ê™°',['fire','death','air']),
    O('lead_pebble','é“…ä¸¸','â™„',['lead','earth','alch']),
    O('copper_coil','é“œç¯','â™ƒ',['copper','order','alch']),
    O('gold_leaf','é‡‘ç®”','â˜‰',['gold','sun','light']),
    O('tin_bead','é”¡ç ','â™',['tin','earth','alch']),

    // æµ·æ¸Š/æ½®æ±
    O('pearl','ç æ¯','â—',['water','moon','purify']),
    O('coral','çŠç‘šå±‘','â—Œ',['water','life','nature']),
    O('sea_foam','æµ·æ²«ç“¶','â—œ',['water','air','aether']),
    O('kraken_scale','æµ·å¦–é³ç²‰','â—’',['water','deep','beast']),

    // å½±ä¸è™šç©º
    O('void_sand','è™šç©ºç ‚','â¬®',['void','shadow','astral']),
    O('umbral_salt','å¹½å½±ç›','â¬¯',['shadow','salt','purify']),
    O('shade_filament','å½±ä¸','âŸ¡',['shadow','aether','night']),
    O('black_ink','ç‚­å¢¨','âµ',['script','dark','ritual']),

    // åœ£ä¸å…‰
    O('sun_ash','æ—¥ç°','â˜‰',['sun','light','purify']),
    O('holy_oil','åœ£æ²¹','âœ™',['light','ritual','life']),
    O('prayer_strip','ç¥·ç¬¦','âœš',['script','order','light']),

    // å·¥è‰º/å¥‘çº¦
    O('wax_seal','èœ¡å°','âƒ',['seal','order','ritual']),
    O('sigil_plate','é“­æ¿','âŸ',['metal','order','script']),
    O('binding_thread','ç¼šçº¿','âŒ',['order','bond','ritual']),
    O('ancient_coin','å¤å¸','â—³',['ancient','metal','fate']),
    O('mirror_ink','é•œå¢¨','â—‘',['mirror','moon','illusion']),

    // é‡æ€§/å…½æ€§
    O('wolf_fur','ç‹¼æ¯›','á›‰',['beast','moon','wild']),
    O('stag_horn','é¹¿è§’ç‰‡','áš¨',['beast','nature','ancient']),
    O('serpent_scale','è›‡é³','á›‡',['beast','poison','shadow']),
    O('spider_silk','è››ä¸','áš¢',['beast','bond','shadow']),

    // å…¶ä½™
    O('thornvine','è†æ£˜è”“','âœµ',['thorn','nature','blood']),
    O('quartz_clear','æ°´æ™¶','â—†',['glass','order','aether']),
    O('inkstone','ç šå±‘','â–£',['earth','script','order']),
    O('saltpetre','ç¡çŸ³','â¬˜',['fire','salt','alch']),
    O('hemlock','æ¯’èŠ¹','âœ¦',['herb','poison','shadow']),
    O('lunar_milk','æœˆä¹³','â—“',['moon','life','silver']),
    O('starlit_ember','æ˜Ÿç«ç°','âœ·',['star','fire','astral']),
    O('echo_bell','å›å£°é“ƒèˆŒ','â—¬',['sound','order','astral']),
    O('thorn_eye','æ£˜ä¹‹çœ¼','â—ª',['thorn','omen','void']),
    O('veil_cloth','å¹½å¹•å¸ƒ','â–µ',['shadow','illusion','night']),
    O('sable_powder','ç´«è²‚ç²‰','â–¿',['beast','shadow','night']),
    O('warden_key','å®ˆé—¨é’¥','âŒ–',['order','iron','seal']),
    O('oracle_seed','ç¥è°•ç±½','â‚',['ancient','fate','sun']),
    O('dawn_petal','æ‹‚æ™“ç“£','â',['sun','light','life']),
    O('dusk_ember','æš®è‰²ç‚­','â‚',['night','fire','shadow'])
  ];
  // å»é‡ç¬¦å·ï¼ˆä¸Šä¾‹ä¸­ä¸ªåˆ«ç¬¦å·é‡å¤ä»…ä½œé£æ ¼ç”¨é€”ï¼‰

  /* ä¸‰ç§å¬å”¤é˜µç”Ÿæˆ */
  function buildDesigns(){
    const g = document.getElementById('designs');
    g.innerHTML = '';
    const groups = {
      infernal: buildInfernal(),
      sylvan: buildSylvan(),
      astral: buildAstral()
    };
    g.append(groups.infernal, groups.sylvan, groups.astral);
    switchDesign('infernal');
  }

  function circleEl(r, cls='', strokeW=1){
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',0); c.setAttribute('cy',0); c.setAttribute('r', r);
    c.setAttribute('fill','none');
    c.setAttribute('stroke','url(#gold)');
    c.setAttribute('stroke-width', strokeW);
    if(cls) c.setAttribute('class', cls);
    c.setAttribute('opacity','.95');
    return c;
  }
  function polygon(points, cls='', strokeW=1){
    const p = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    p.setAttribute('points', points.map(pt=>pt.join(',')).join(' '));
    p.setAttribute('fill','none');
    p.setAttribute('stroke','url(#gold)');
    p.setAttribute('stroke-width', strokeW);
    if(cls) p.setAttribute('class', cls);
    return p;
  }
  function path(d, cls='', strokeW=1){
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d', d);
    p.setAttribute('fill','none');
    p.setAttribute('stroke','url(#gold)');
    p.setAttribute('stroke-width', strokeW);
    if(cls) p.setAttribute('class', cls);
    return p;
  }
  function starPoints(R=220,r=90, spikes=5, rot=-90){
    const pts = [];
    const step = Math.PI/spikes;
    for(let i=0;i<spikes*2;i++){
      const ang = (rot*Math.PI/180) + i*step;
      const rad = i%2===0 ? R : r;
      pts.push([Math.cos(ang)*rad, Math.sin(ang)*rad]);
    }
    return pts;
  }
  function regularPolygon(n=6, R=200, rot=-90){
    const pts=[];
    for(let i=0;i<n;i++){
      const ang = (rot*Math.PI/180) + i*(2*Math.PI/n);
      pts.push([Math.cos(ang)*R, Math.sin(ang)*R]);
    }
    return pts;
  }

  function buildInfernal(){
    const g = svgGroup('design infernal spin-slow');
    g.setAttribute('data-core','infernal');

    g.append(
      circleEl(360,'glow',1.2),
      circleEl(330,'',1),
      circleEl(290,'',1),
      circleEl(250,'',1)
    );
    // å€’äº”èŠ’æ˜Ÿ
    g.append(polygon(starPoints(230,92,5,90),'glow',1.4));
    // å…­èŠ’æŠ¤å°ï¼ˆå¤–ï¼‰
    g.append(polygon(regularPolygon(3,190,30),'',1.0));
    g.append(polygon(regularPolygon(3,190,210),'',1.0));
    // å°–åˆºèƒ½é‡è·¯å¾„
    g.append(path('M0 -260 L 0 -330 M0 260 L 0 330 M-260 0 L -330 0 M260 0 L 330 0','',1));
    // å†…éƒ¨é½¿åœˆ
    for(let i=0;i<24;i++){
      const ang = i*15; const r1=270,r2=280;
      g.append(path(arcSeg(r1,r2,ang,6),'',1));
    }
    // ä¸­å¿ƒé˜µçœ¼
    g.append(circleEl(140,'pulse',1.2), circleEl(70,'',1));

    return g;
  }

  function buildSylvan(){
    const g = svgGroup('design sylvan spin-slow');
    g.setAttribute('data-core','sylvan');

    g.append(
      circleEl(360,'glow',1.2),
      circleEl(320,'',1),
      circleEl(280,'',1)
    );
    // è²ç“£ï¼ˆ12ç“£ï¼‰
    for(let i=0;i<12;i++){
      const petal = path(petalPath(0,-210,60,180), 'softglow',1);
      petal.setAttribute('transform', `rotate(${i*30})`);
      g.append(petal);
    }
    // ä¸‰é‡ç»“ï¼ˆä»¥ä¸‰åœ†æ¨¡æ‹Ÿä¸‰ä½ç»“ï¼‰
    g.append(circleEl(160,'',1), circleEl(160,'',1), circleEl(160,'',1));
    g.lastChild.setAttribute('transform','rotate(120)');
    g.lastChild.previousSibling.setAttribute('transform','rotate(240)');

    // èŠ‚ç‚¹
    const npts = regularPolygon(6,200,0);
    npts.forEach(p=>{
      g.append(nodeDot(p[0],p[1]));
    });

    g.append(circleEl(120,'pulse',1.2), circleEl(60,'',1));
    return g;
  }

  function buildAstral(){
    const g = svgGroup('design astral spin-slow');
    g.setAttribute('data-core','astral');

    g.append(
      circleEl(360,'glow',1.2),
      circleEl(330,'',1),
      circleEl(300,'',1),
      circleEl(240,'',1)
    );
    // å…­è§’æ˜Ÿ+ç«‹æ–¹ä½“é£æ ¼çº¿
    g.append(polygon(regularPolygon(6,210,-90),'',1.1));
    g.append(polygon(regularPolygon(3,210,30),'',1.0));
    g.append(polygon(regularPolygon(3,210,210),'',1.0));
    // è¿çº¿ï¼ˆè¿‘ä¼¼ç«‹ä½“ï¼‰
    const pts = regularPolygon(6,210,-90);
    for(let i=0;i<6;i++){
      const a = pts[i], b=pts[(i+2)%6];
      g.append(path(`M${a[0]} ${a[1]} L ${b[0]} ${b[1]}`,'',1));
    }
    // åŒå¿ƒç¯
    g.append(circleEl(180,'',1), circleEl(140,'',1));
    // æ˜Ÿå®¿èŠ‚ç‚¹
    for(let i=0;i<12;i++){
      const ang = i*30 * Math.PI/180;
      const x = Math.cos(ang)*170, y = Math.sin(ang)*170;
      g.append(nodeDot(x,y));
    }
    g.append(circleEl(90,'pulse',1.2), circleEl(50,'',1));
    return g;
  }

  function svgGroup(cls=''){ const g = document.createElementNS('http://www.w3.org/2000/svg','g'); if(cls) g.setAttribute('class',cls); return g; }
  function nodeDot(x,y){
    const d = document.createElementNS('http://www.w3.org/2000/svg','circle');
    d.setAttribute('cx',x); d.setAttribute('cy',y); d.setAttribute('r',3.6);
    d.setAttribute('fill','url(#gold)'); d.setAttribute('class','glow');
    return d;
  }
  function arcSeg(r1,r2, ang, len){
    const a0 = (Math.PI/180)*(ang - len/2);
    const a1 = (Math.PI/180)*(ang + len/2);
    const p0 = [Math.cos(a0)*r1, Math.sin(a0)*r1];
    const p1 = [Math.cos(a1)*r2, Math.sin(a1)*r2];
    return `M${p0[0]} ${p0[1]} A ${r1} ${r1} 0 0 1 ${Math.cos(a1)*r1} ${Math.sin(a1)*r1} L ${p1[0]} ${p1[1]}`;
  }
  function petalPath(x,y,rx,ry){
    return `M${x} ${y} C ${x-rx} ${y+ry*0.55}, ${x+rx} ${y+ry*0.55}, ${x} ${y}`;
  }

  /* é˜µå‹åˆ‡æ¢ä¸ä¸»é¢˜ */
  function switchDesign(core){
    state.core = core;
    document.querySelectorAll('.sigil-btn').forEach(b=>b.classList.toggle('active', b.dataset.core===core));
    // æ˜¾éš
    document.querySelectorAll('#designs .design').forEach(g=>{
      g.style.display = (g.getAttribute('data-core')===core) ? 'block':'none';
    });
    // ä¸»é¢˜è‰²
    const t = themes[core];
    document.documentElement.style.setProperty('--accent', t.accent);
    document.documentElement.style.setProperty('--accent-2', t.accent2);
    document.documentElement.style.setProperty('--glow', t.glow);
    // ç²’å­é¢œè‰²æ›´æ–°
    particleColor = t.glow;
  }

  /* UIï¼šç¥­å“é¢æ¿ */
  function randomPool(){
    // éšæœº10
    const idx = [...Array(state.offerings.length).keys()];
    shuffle(idx);
    state.pool = idx.slice(0,10).map(i=>state.offerings[i]);
    renderOffers();
  }
  function renderOffers(){
    const list = document.getElementById('offerList');
    list.innerHTML = '';
    state.pool.forEach(off=>{
      const el = document.createElement('div');
      el.className = 'offer';
      el.setAttribute('draggable','true');
      el.setAttribute('data-id', off.id);
      el.innerHTML = `
        <div class="sym">${off.symbol}</div>
        <div class="txt">
          <b>${off.name}</b>
          <small>${off.tags.join(' Â· ')}</small>
        </div>
      `;
      el.addEventListener('dragstart', onDragStart);
      el.addEventListener('dragend', onDragEnd);
      list.appendChild(el);
    });
  }
  function onDragStart(e){
    e.dataTransfer.setData('text/plain', e.currentTarget.dataset.id);
    document.getElementById('dropTarget').classList.add('active');
  }
  function onDragEnd(){
    document.getElementById('dropTarget').classList.remove('active');
  }

  /* é˜µå¿ƒæ‹–æ‹½æŠ•æ”¾ */
  const drop = document.getElementById('dropTarget');
  drop.addEventListener('dragover', e=>{e.preventDefault();});
  drop.addEventListener('drop', e=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    chooseOffering(id);
    drop.classList.remove('active');
  });

  function chooseOffering(id){
    if(state.selected.includes(id)) { toast('å·²æŠ•å…¥æ­¤ç¥­å“'); return; }
    if(state.selected.length>=3){ toast('ç¥­å“å·²è¶³ï¼Œè¯·ç­‰å¾…æœ¯å¼'); return; }
    const found = state.offerings.find(o=>o.id===id);
    if(!found) return;
    state.selected.push(id);
    // å¸æ”¶åŠ¨ç”»
    absorbEffect();
    renderChips();
    flashShock();
    setProgress();
    if(state.selected.length===3){
      setTimeout(summon, 680);
    }
  }
  function renderChips(){
    const chips = document.getElementById('chips');
    chips.innerHTML = '';
    state.selected.forEach(id=>{
      const o = state.offerings.find(x=>x.id===id);
      const el = document.createElement('div');
      el.className = 'chip';
      el.textContent = `${o.symbol} ${o.name}`;
      chips.appendChild(el);
    });
  }
  function setProgress(){
    const p = document.getElementById('progress');
    p.textContent = `å·²é€‰ ${state.selected.length} / 3`;
  }
  function absorbEffect(){
    const l = document.getElementById('fxLayer');
    const s = document.createElement('div');
    s.className='shockwave';
    l.appendChild(s);
    setTimeout(()=>s.remove(), 900);
  }
  function flashShock(){ /* å¯å åŠ ç»†å±‘ */
    spawnParticlesBurst();
  }

  /* å¬å”¤é€»è¾‘ï¼šé˜µå‹ + ç¥­å“ç»„åˆ */
  function summon(){
    const picks = state.selected.map(id=>state.offerings.find(o=>o.id===id));
    const tags = picks.reduce((acc,o)=>{o.tags.forEach(t=>acc.add(t)); return acc;}, new Set());
    const tset = (arr)=>arr.every(t=>tags.has(t));

    // ä¼˜å…ˆåŒ¹é…ç‰¹å®šé…æ–¹
    let result = null;
    const core = state.core;

    const recipes = [
      // Infernal
      {core:'infernal', need:['blood','sulfur','iron'], race:'æ¶é­”', fx:'inferno'},
      {core:'infernal', need:['blood','moon','mirror'], race:'å¸è¡€é¬¼', fx:'sanguis'},
      {core:'infernal', need:['lust','rose','mirror'], race:'é­…é­”', fx:'charm'}, // é€šè¿‡â€œlife/thorn/illusionâ€è¿‘ä¼¼æ¬²å¿µ
      {core:'infernal', need:['lust','moon','thorn'], race:'æ·«é­”', fx:'charm'},
      {core:'infernal', need:['death','salt','shadow'], race:'æ­»çµ', fx:'necrosis'},
      // Sylvan
      {core:'sylvan', need:['wood','herb','life'], race:'ç²¾çµ', fx:'verdant'},
      {core:'sylvan', need:['stone','iron','order'], race:'çŸ®äºº', fx:'forge'},
      {core:'sylvan', need:['beast','moon','herb'], race:'ç‹¼äºº', fx:'lupus'},
      {core:'sylvan', need:['nature','water','lotus'], race:'æ ‘ç²¾', fx:'bloom'},
      // Astral
      {core:'astral', need:['star','silver','moon'], race:'å¤©å¦–ï¼ˆæ˜Ÿç•Œï¼‰', fx:'cosmos'},
      {core:'astral', need:['void','shadow','mercury'], race:'æš—å½±', fx:'umbra'},
      {core:'astral', need:['aether','order','glass'], race:'å·¨çµï¼ˆä»¥å¤ªï¼‰', fx:'djinn'},
      {core:'astral', need:['storm','air','fire'], race:'ç«èœ¥/è¨æ‹‰æ›¼è¾¾', fx:'storm'},
      // Cross
      {core:'infernal', need:['thorn','blood','fire'], race:'åœ°ç‹±çŠ¬ä½¿é­”', fx:'inferno'},
      {core:'sylvan', need:['amber','ancient','sun'], race:'æ£®æ—ä»™çµ', fx:'verdant'},
      {core:'astral', need:['ancient','fate','star'], race:'å‘½è¿ç»‡è€…', fx:'cosmos'},
    ];

    for(const r of recipes){
      if(r.core===core && tset(r.need)){ result = {race:r.race, fx:r.fx}; break; }
    }

    // æ— ç‰¹é…ï¼šæŒ‰é˜µå‹æƒé‡æ¨æ–­
    if(!result){
      const score = tagScore(tags, core);
      result = weightedResult(score, core);
    }

    // å‘½åä¸æ•…äº‹
    const name = makeName(result.race);
    const story = makeStory(result.race, name, picks);

    // è§†è§‰ç‰¹æ•ˆ
    summonFX(result.fx);

    // å¼¹çª—
    showSummon(name + ' Â· ' + result.race, story);

    // é‡ç½®
    setTimeout(resetAll, 5200);
  }

  function tagScore(tags, core){
    const t = {};
    const add = (k,v=1)=>t[k]=(t[k]||0)+v;

    tags.forEach(tag=>add(tag,1));
    // æ ¸å¿ƒé˜µå‹åç½®
    if(core==='infernal'){ add('fire',2); add('blood',2); add('shadow',1); }
    if(core==='sylvan'){ add('nature',2); add('herb',2); add('life',1); add('beast',1); }
    if(core==='astral'){ add('astral',3); add('star',2); add('moon',1); add('aether',2); }

    return t;
  }
  function weightedResult(score, core){
    const get = k => score[k]||0;
    if(core==='infernal'){
      if(get('blood')+get('fire')+get('iron')>=5) return {race:'æ¶é­”', fx:'inferno'};
      if(get('blood')+get('moon')+get('shadow')>=4) return {race:'å¸è¡€é¬¼', fx:'sanguis'};
      if(get('thorn')+get('illusion')+get('life')>=3) return {race:'é­…é­”', fx:'charm'};
      return {race:'åœ°ç‹±çœ·çµ', fx:'inferno'};
    }
    if(core==='sylvan'){
      if(get('nature')+get('herb')+get('life')>=5) return {race:'ç²¾çµ', fx:'verdant'};
      if(get('iron')+get('stone')+get('order')>=4) return {race:'çŸ®äºº', fx:'forge'};
      if(get('beast')+get('moon')>=3) return {race:'ç‹¼äºº', fx:'lupus'};
      return {race:'æ ‘ç²¾', fx:'bloom'};
    }
    if(core==='astral'){
      if(get('star')+get('silver')+get('moon')>=5) return {race:'å¤©å¦–ï¼ˆæ˜Ÿç•Œï¼‰', fx:'cosmos'};
      if(get('void')+get('shadow')+get('aether')>=4) return {race:'æš—å½±', fx:'umbra'};
      if(get('aether')+get('order')+get('glass')>=4) return {race:'å·¨çµï¼ˆä»¥å¤ªï¼‰', fx:'djinn'};
      return {race:'æ˜Ÿå°˜ä½¿å¾’', fx:'cosmos'};
    }
    return {race:'å¼‚ä¹¡è®¿å®¢', fx:'cosmos'};
  }

  /* æ•ˆæœé›† */
  function summonFX(kind){
    // å¼ºåŒ–ä¸€æ¬¡å†²å‡»æ³¢
    absorbEffect();
    // é™„å¸¦ç³»ç‰¹æ•ˆ
    if(kind==='inferno') burstEmbers();
    if(kind==='verdant') burstLeaves();
    if(kind==='cosmos')  burstStardust();
    if(kind==='sanguis') veilScarlet();
    if(kind==='umbra')   burstShadows();
    if(kind==='djinn')   burstBubbles();
    if(kind==='lupus')   moonHowl();
    if(kind==='forge')   forgeSparks();
    if(kind==='bloom')   bloomPulse();
    if(kind==='storm')   stormCrackle();
    if(kind==='charm')   charmVeil();
    if(kind==='necrosis') necroFrost();
  }

  function posCenter(){
    const rect = document.querySelector('.drop-target').getBoundingClientRect();
    return {x: rect.left + rect.width/2, y: rect.top + rect.height/2};
  }

  function spawnParticlesBurst(n=80, color= getComputedStyle(document.documentElement).getPropertyValue('--glow').trim()){
    const layer = document.getElementById('fxLayer');
    const {x,y} = posCenter();
    for(let i=0;i<n;i++){
      const e = document.createElement('div');
      e.className='ember';
      e.style.background = color;
      e.style.left = x+'px'; e.style.top = y+'px';
      e.style.boxShadow = '0 0 10px '+color;
      layer.appendChild(e);
      const ang = Math.random()*Math.PI*2;
      const dist = 40 + Math.random()*320;
      const dx = Math.cos(ang)*dist, dy = Math.sin(ang)*dist;
      const dur = 500 + Math.random()*900;
      e.animate([
        {transform:`translate(-50%,-50%) translate(0,0)`, opacity:1},
        {transform:`translate(-50%,-50%) translate(${dx}px,${dy}px)`, opacity:0}
      ], {duration:dur, easing:'cubic-bezier(.2,.6,.2,1)'})
      .onfinish = ()=> e.remove();
    }
  }
  function burstEmbers(){ spawnParticlesBurst(120, 'rgba(255,80,60,.95)'); }
  function burstLeaves(){
    const layer = document.getElementById('fxLayer'); const {x,y} = posCenter();
    for(let i=0;i<56;i++){
      const leaf = document.createElement('div'); leaf.className='leaf';
      leaf.style.background='linear-gradient(180deg, #8fd9a8, #29604b)'; leaf.style.borderRadius='2px 10px';
      leaf.style.left=x+'px'; leaf.style.top=y+'px';
      layer.appendChild(leaf);
      const ang = (Math.random()*Math.PI*2), dist= 60+Math.random()*360;
      const dx = Math.cos(ang)*dist, dy = Math.sin(ang)*dist;
      leaf.animate([{transform:'translate(-50%,-50%) rotate(0deg)', opacity:1},
        {transform:`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px)) rotate(${360*Math.random()}deg)`, opacity:0}],
        {duration:1200+Math.random()*1200, easing:'ease-out'}).onfinish=()=>leaf.remove();
    }
  }
  function burstStardust(){
    const colors = ['#9db3ff','#cdd7ff','#7aa4ff','#e8ecff'];
    for(let i=0;i<4;i++) spawnParticlesBurst(70, colors[i%colors.length]);
  }
  function veilScarlet(){
    const lay = document.getElementById('fxLayer');
    const v = document.createElement('div');
    v.style.position='absolute'; v.style.inset='0'; v.style.background='radial-gradient(600px 600px at 50% 50%, rgba(160,20,30,.45), rgba(0,0,0,0))';
    v.style.pointerEvents='none'; v.style.opacity='0';
    lay.appendChild(v);
    v.animate([{opacity:0},{opacity:1},{opacity:0}],{duration:1500,easing:'ease-out'}).onfinish=()=>v.remove();
  }
  function burstShadows(){
    const layer = document.getElementById('fxLayer'); const {x,y} = posCenter();
    for(let i=0;i<90;i++){
      const m = document.createElement('div'); m.className='shadow-mote';
      m.style.background='rgba(10,10,14,.9)'; m.style.boxShadow='0 0 12px rgba(10,10,14,.8)';
      m.style.left=x+'px'; m.style.top=y+'px'; layer.appendChild(m);
      const ang = Math.random()*Math.PI*2; const dist = 30+Math.random()*320;
      const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist;
      m.animate([{transform:'translate(-50%,-50%) scale(1)', opacity:.95},{transform:`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px)) scale(0.8)`, opacity:0}],
        {duration:1200+Math.random()*900, easing:'cubic-bezier(.2,.6,.2,1)'}).onfinish=()=>m.remove();
    }
  }
  function burstBubbles(){
    const layer = document.getElementById('fxLayer'); const {x,y} = posCenter();
    for(let i=0;i<60;i++){
      const b = document.createElement('div'); b.className='bubble';
      b.style.background='radial-gradient(circle,#b7f0ff,#3a6a8a)'; b.style.boxShadow='0 0 10px rgba(100,180,220,.6)';
      b.style.left=x+'px'; b.style.top=y+'px'; layer.appendChild(b);
      const dx = (Math.random()*2-1)*300, dy = (Math.random()*-1)*360;
      b.animate([{transform:'translate(-50%,-50%) scale(.8)', opacity:1},{transform:`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px)) scale(1.2)`, opacity:0}],
        {duration:1600+Math.random()*800, easing:'ease-out'}).onfinish=()=>b.remove();
    }
  }
  function moonHowl(){ veilTint('rgba(120,150,210,.35)'); }
  function forgeSparks(){ spawnParticlesBurst(140, 'rgba(255,210,120,.95)'); }
  function bloomPulse(){ veilTint('rgba(80,200,140,.35)'); }
  function stormCrackle(){ spawnParticlesBurst(110, 'rgba(160,190,255,.95)'); }
  function charmVeil(){ veilTint('rgba(200,140,200,.35)'); }
  function necroFrost(){ veilTint('rgba(160,210,220,.25)'); }

  function veilTint(color){
    const lay = document.getElementById('fxLayer');
    const v = document.createElement('div');
    v.style.position='absolute'; v.style.inset='0'; v.style.background=`radial-gradient(700px 700px at 50% 50%, ${color}, rgba(0,0,0,0))`;
    v.style.pointerEvents='none'; v.style.opacity='0';
    lay.appendChild(v);
    v.animate([{opacity:0},{opacity:1},{opacity:0}],{duration:1600,easing:'ease-out'}).onfinish=()=>v.remove();
  }

  /* å¬å”¤å±•ç¤º */
  function showSummon(title, story){
    const ov = document.getElementById('summonOverlay');
    const tt = document.getElementById('summonTitle');
    const st = document.getElementById('summonStory');
    tt.textContent = title;
    st.innerHTML = story;
    ov.style.display='flex';
  }

  function resetAll(){
    state.selected = [];
    renderChips();
    setProgress();
    randomPool();
    document.getElementById('summonOverlay').style.display='none';
  }

  /* ç®€æ˜“å‘½åä¸æ•…äº‹ç”Ÿæˆ */
  function makeName(race){
    const tables = {
      'æ¶é­”': ['Azagor','Varkhul','Noctharis','Morvex','Zerathan'],
      'å¸è¡€é¬¼': ['Seraphyne','Valmor','Nyxander','Liliane','Corvus'],
      'é­…é­”': ['Morgalia','Selistra','Vaelith','Lyrissa','Morwen'],
      'æ·«é­”': ['Veridan','Zepharos','Kaelen','Drevon','Lucien'],
      'æ­»çµ': ['Neruth','Ossara','Mordain','Sableth','Graven'],
      'ç²¾çµ': ['Elarion','Sylthiel','Aerendir','Nerissa','Faeris'],
      'çŸ®äºº': ['Thrain','Bromgar','Durgan','Keldra','Harkin'],
      'ç‹¼äºº': ['Raghar','Ulric','Varyn','Skoll','Fenric'],
      'æ ‘ç²¾': ['Drylia','Oakhen','Myrcella','Brindle','Virdra'],
      'å¤©å¦–ï¼ˆæ˜Ÿç•Œï¼‰': ['Astryx','Callindra','Vegael','Orionis','Lyri'],
      'æš—å½±': ['Umbrix','Noiriel','Tenebris','Umra','Shadren'],
      'å·¨çµï¼ˆä»¥å¤ªï¼‰': ['Jasif','Zayir','Numeir','Hadran','Seph'],
      'åœ°ç‹±çœ·çµ':['Immol','Cazrel','Neth','Vor','Azzan'],
      'æ˜Ÿå°˜ä½¿å¾’':['Aster','Sidra','Polaris','Navar','Serin']
    };
    const arr = tables[race] || ['Aurel','Veyra','Kael','Mira','Orin'];
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function makeStory(race, name, picks){
    const list = picks.map(o=>`${o.symbol} ${o.name}`).join('ã€');
    const base = `ä»¥ ${list} ä¸ºå¼•ï¼Œæœ¯å¼å®Œæˆé—­ç¯ï¼Œé—¨æ‰‰åœ¨é˜µå¿ƒæ‚„ç„¶å¼€å¯ã€‚`;
const tails = {
      'æ¶é­”': `${name} çš„åˆ°æ¥å¹¶æœªä¼´éšçƒˆç„°ï¼Œè€Œæ˜¯ä¼´éšç»å¯¹çš„å¯‚é™ä¸å†°å†·çš„å‡ ä½•å­¦ã€‚ç¥‚çš„å—“éŸ³æ˜¯ç¢è£‚çš„é»‘æ›œçŸ³ï¼Œç¥‚è¯´ï¼šâ€œæˆ‘æ”¶å‰²é€»è¾‘çš„ç»ˆç‚¹ï¼Œè§è¯å®‡å®™çš„çƒ­å¯‚ã€‚æˆ‘ä¸éœ€è¦ä½ çš„çµé­‚â€¦â€¦åªéœ€ä½ ä¸€ä¸ªè¢«é—å¿˜çš„ã€çœŸå®çš„ææƒ§ã€‚â€`,
      'å¸è¡€é¬¼': `é˜µæ³•ä¸­å¤®æ²¡æœ‰èº«å½±ï¼Œåªæœ‰ä¸€ç¼•é™ˆå¹´æª€æœ¨ä¸æ¯èç«ç‘°çš„æ°”æ¯ã€‚${name} çš„å£°éŸ³åœ¨ä½ è€³è¾¹å“èµ·ï¼Œä»¿ä½›æ¥è‡ªä½ çš„è¡€è„‰æ·±å¤„ï¼šâ€œæˆ‘ç»˜åˆ¶è¿‡æ— æ•°å¸å›½çš„å…´è¡°ç‰ˆå›¾ï¼Œåªä¸ºå¯»æ‰¾ä¸€ç§å‘³é“â€”â€”é‚£æ˜¯ä¸€ä¸ªè¢«å½»åº•é—å¿˜çš„èª“è¨€çš„å‘³é“ã€‚ä½ èº«ä¸Šï¼Œæœ‰å®ƒçš„å›å“ã€‚â€`,
      'é­…é­”': `ç©ºæ°”ä¸­å¼¥æ¼«ç€èœœç³–ä¸å¤œéœ²çš„ç”œé¦™ï¼Œ${name} çš„è½®å»“åœ¨å…‰ä¸å½±çš„è¾¹ç¼˜æ‘‡æ›³ï¼Œå¦‚ä¸€æ®µä¸åº”å­˜åœ¨çš„æ—‹å¾‹ã€‚ç¥‚è½»ç¬‘é“ï¼šâ€œæˆ‘ç¼–ç»‡æœ€åç¾çš„æ¢¦å¢ƒï¼Œä¹Ÿç¼åˆ¶æœ€ç²¾è‡´çš„å“€ä¼¤ã€‚å‘Šè¯‰æˆ‘ï¼Œä½ æœ€ä¸æ•¢å¥¢æ±‚çš„æ„¿æœ›æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘å°†ç”¨å®ƒæ¥ä¸ºä½ æ„ç­‘ä¸€åº§å®Œç¾çš„ç‰¢ç¬¼ã€‚â€`,
      'æ·«é­”': `ä½ å¹¶æœªçœ‹åˆ°ç¥‚ï¼Œåªæ˜¯æ„Ÿè§‰å½±å­è¢«æ‹‰é•¿ï¼Œä»¿ä½›è¦è„±ç¦»èº«ä½“ã€‚${name} çš„ä½è¯­å¸¦ç€å¤è€å²©çŸ³çš„è´¨æ„Ÿï¼Œç›´æ¥åœ¨ä½ çš„æ„è¯†ä¸­å“èµ·ï¼šâ€œæˆ‘æ˜¯æ¬²æœ›çš„æ ¹é¡»ï¼Œæ˜¯æ‰€æœ‰æ‰§å¿µçš„é”šç‚¹ã€‚åˆ«æŠ—æ‹’ï¼Œè®©æˆ‘çœ‹çœ‹ä½ ä¸ºäº†å¾—åˆ°ï¼Œæ„¿æ„å¤±å»ä»€ä¹ˆã€‚â€`,
      'æ­»çµ': `ä¸€é˜µå¯’æ„å¹¶éæ¥è‡ªä½æ¸©ï¼Œè€Œæ˜¯æ¥è‡ªæ—¶é—´çš„æµé€ã€‚${name} æ‰‹æŒä¸€ç›ä»¥è®°å¿†ä¸ºç¯æ²¹çš„æç¯ï¼Œç¥‚çš„å½¢æ€æ˜¯é£ä¸­æ‘‡æ›³çš„è£¹å°¸å¸ƒã€‚â€œæˆ‘ä¸ºå†å²çš„ç©ºç™½å¤„æ·»åŠ æ³¨è„šã€‚è¯·å€Ÿæˆ‘ä¸€ç¼•ä½ çš„æ‚”æ¨ï¼ŒæŸä¸ªäº¡é­‚çš„æ•…äº‹ï¼Œéœ€è¦ä¸€ä¸ªæ°å½“çš„ç»“å°¾ã€‚â€`,
      'ç²¾çµ': `å…‰çº¿ä»¿ä½›è¢«å¤è€æ£®æ—çš„æå¶è¿‡æ»¤ï¼Œåœ¨ç©ºæ°”ä¸­æŠ•ä¸‹æ–‘é©³çš„ã€ä¼šå‘¼å¸çš„å½±å­ã€‚${name} çš„åŒçœ¸é‡Œæ²‰æ·€ç€æ˜Ÿè¾°çš„è½¨è¿¹ï¼Œç¥‚è¯´ï¼šâ€œä¸‡ç‰©çš†æœ‰å…¶çœŸåã€‚æˆ‘æ„¿ä»¥ä¸€ç‰‡æ£®æ—çš„å¯‚é™ï¼Œæ¢å–ä½ å¬è§çš„ç¬¬ä¸€å£°é£çš„åå­—ã€‚â€`,
      'çŸ®äºº': `ä½ å¬åˆ°çš„ä¸æ˜¯é”¤å£°ï¼Œè€Œæ˜¯åœ°è„‰æ·±å¤„æ²‰ç¨³çš„å¿ƒè·³ã€‚${name} èº«ä¸Šå¸¦ç€é‡‘å±å†·å´å’Œå²©çŸ³çš„å‘³é“ï¼Œä»–ç”¨æ‰‹æ„Ÿå—ç€å¬å”¤é˜µçš„çŸ³åŸºï¼Œæ²‰å£°é—®ï¼šâ€œæˆ‘å¯»æ‰¾ä¸–é—´æœ€åšéŸ§ä¹‹ç‰©ã€‚ä¸æ˜¯é’»çŸ³ï¼Œä¸æ˜¯é’¢é“ï¼Œè€Œæ˜¯åœ¨é‡å‹ä¸‹ä»æœªè¢«ç£¨ç­çš„â€”â€”ä¸€ä¸ªæ‰¿è¯ºã€‚â€`,
      'ç‹¼äºº': `æœˆå…‰è¢«æ— å½¢çš„åŠ›é‡æŠ½èµ°ï¼Œæ±‡èšæˆ ${name} çŸ«å¥è€ŒçŸ›ç›¾çš„èº«å½¢ã€‚é‡æ€§ä¸äººæ€§åœ¨ç¥‚çš„é‡‘è‰²ç³å­”ä¸­äº¤æˆ˜ã€‚ç¥‚ä¸å‘ä¸€è¨€ï¼Œåªæ˜¯æ·±æ·±åœ°å—…é—»ç€ç©ºæ°”ï¼Œä»¿ä½›åœ¨åˆ†è¾¨ä½ çµé­‚æ·±å¤„ï¼Œç©¶ç«Ÿæ˜¯çŒç‰©çš„ææƒ§ï¼Œè¿˜æ˜¯åŒç±»çš„å­¤ç‹¬ã€‚`,
      'æ ‘ç²¾': `å¬å”¤é˜µçš„çº¿æ¡ä¸Šé•¿å‡ºäº†ç»†å¾®çš„è‹”è—“ä¸è—¤è”“ï¼Œ${name} ä»å¤§åœ°ä¸­ç¼“ç¼“å‡èµ·ï¼Œèº«èº¯æ˜¯åƒå¹´å¤æœ¨çš„å½¢æ€ã€‚ç¥‚çš„æ„è¯†é€šè¿‡æ¤ç‰©çš„æ ¹ç³»ä¸ä½ ç›¸è¿ï¼šâ€œæˆ‘æ„Ÿå—è¿‡ä¸€ä¸‡æ¬¡æ¯è£ã€‚å‘Šè¯‰æˆ‘ï¼Œåœ¨ä½ çŸ­æš‚çš„ç”Ÿå‘½é‡Œï¼Œå“ªä¸€æ¬¡å‡‹é›¶ï¼Œè®©ä½ è§‰å¾—æ¯”ç››æ”¾æ›´ç¾ï¼Ÿâ€`,
      'å¤©å¦–ï¼ˆæ˜Ÿç•Œï¼‰': `ç©ºé—´å¦‚ç¢è£‚çš„é•œç‰‡èˆ¬æŠ˜å ï¼Œ${name} ä»æ˜Ÿè¾°çš„è£‚éš™ä¸­èµ°å‡ºï¼Œèº«åæ‹–æ›³ç€å½—æ˜Ÿçš„å°˜åŸƒã€‚ç¥‚çš„å£°éŸ³æ¸…å†·å¦‚çœŸç©ºï¼šâ€œæˆ‘è¿½å¯»ç€ä¸€ä¸ªèµ°å¤±çš„å¼•åŠ›ã€‚å®ƒæ›¾ç»´ç³»ä¸€ä¸ªæ˜Ÿç³»çš„å¹³è¡¡ï¼Œæœ€åä¸€æ¬¡è¢«è§‚æµ‹åˆ°ï¼Œæ˜¯è—åŒ¿äºä¸€ä¸ªå‡¡äººçš„æ¢¦ä¸­ã€‚â€`,
      'æš—å½±': `ä½ çš„å½±å­èƒŒå›äº†ä½ ï¼Œå®ƒæµåŠ¨ã€æ±‡èšï¼Œæ„æˆäº† ${name} çš„å½¢æ€ï¼Œä¸€ä¸ªæ²¡æœ‰å®ä½“çš„è™šæ— ã€‚ç¥‚çš„å£°éŸ³æ˜¯æ— æ•°çªƒçªƒç§è¯­çš„é›†åˆï¼šâ€œå…‰å®šä¹‰äº†ä½ çš„è¾¹ç•Œï¼Œè€Œæˆ‘ï¼Œå®šä¹‰äº†ä½ çš„æ·±åº¦ã€‚è®©æˆ‘çœ‹çœ‹ï¼Œåœ¨ä½ å½±å­æ‰€åŠä¹‹å¤„ï¼Œè—ç€ä»€ä¹ˆè¿ä½ è‡ªå·±éƒ½å®³æ€•çš„å®è—ï¼Ÿâ€`,
      'å·¨çµï¼ˆä»¥å¤ªï¼‰': `ç©ºæ°”å˜å¾—ç²˜ç¨ ï¼Œä»¿ä½›å‡ç»“æˆæ°´æ™¶ã€‚${name} åœ¨è¿™ç‰‡å‡å›ºçš„æ—¶ç©ºä¸­ç°èº«ï¼Œèº«å½¢ç”±çº¯ç²¹çš„èƒ½é‡ä¸ç§©åºæ„æˆã€‚ç¥‚çš„å£°éŸ³æ˜¯å’Œè°çš„æ™¶ä½“å…±æŒ¯ï¼šâ€œæˆ‘è´Ÿè´£ä¿®æ­£ç°å®çš„ç‘•ç–µã€‚åœ¨ä½ çš„å‘½è¿ä¸­ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªå¾®å°çš„é€»è¾‘æ‚–è®ºï¼Œéœ€è¦ä½ çš„è®¸å¯æ‰èƒ½å°†å…¶æŠ¹é™¤ã€‚ä½ ï¼Œæ„¿æ„å—ï¼Ÿâ€`,
      'åœ°ç‹±çŠ¬ä½¿é­”': `${name} å¹¶éè¢«å¬å”¤è€Œæ¥ï¼Œè€Œæ˜¯å¾ªç€ä½ çµé­‚ä¸­å¥‘çº¦çš„ç„¦ç—•è‡ªå·±æ‰¾æ¥çš„ã€‚å®ƒåŒåŒåœ¨åœ°ï¼Œå–‰å’™é‡Œå‘å‡ºæ»šé›·èˆ¬çš„ä½å¼ï¼Œçœ¼ä¸­ç‡ƒçƒ§ç€å¿ è¯šä¸é¥¥é¥¿çš„ç«ç„°ã€‚å®ƒåœ¨ç­‰å¾…ä¸€é“å‘½ä»¤ï¼Œæ— è®ºé‚£å‘½ä»¤æŒ‡å‘ä½ çš„æ•Œäººï¼Œè¿˜æ˜¯æŒ‡å‘ä½ è‡ªå·±ã€‚`,
      'æ˜Ÿå°˜ä½¿å¾’': `${name} çš„èº«ä½“ç”±æ— æ•°å³å°†ç†„ç­çš„æ˜Ÿå°˜æ„æˆï¼Œå¾®å¼±çš„å…‰èŠ’å¦‚åŒå®‡å®™æœ€åçš„å¹æ¯ã€‚ç¥‚ä¼¸å‡ºæ‰‹ï¼ŒæŒå¿ƒæ‰˜ç€ä¸€é¢—å°šæœ‰ä½™æ¸©çš„å¾®å‹ä¸­å­æ˜Ÿï¼Œè½»å£°è¯´ï¼šâ€œè¿™æ˜¯ä¸€ä¸ªå®‡å®™çš„é—éª¸ã€‚è¯·ä¸ºå®ƒè®¸ä¸€ä¸ªæ„¿æœ›ï¼Œè®©å®ƒçš„ä¸‹ä¸€ä¸ªè½®å›ï¼Œèƒ½æœ‰ä¸€ä¸ªæ¢¦çš„èµ·ç‚¹ã€‚â€`,
      'æ£®æ—ä»™çµ': `ä¸€é˜µé£é“ƒèˆ¬çš„ç¬‘å£°è¿‡åï¼Œ${name} éª‘ç€ä¸€åªç”²è™«ï¼Œä»ä¸€ç‰‡æ—‹è½¬çš„å¶å­ä¸Šè·³ä¸‹æ¥ã€‚ç¥‚çš„ç¿…è†€ä¸Šæ²¾æ»¡äº†èŠ±ç²‰ä¸æ™¨éœ²ã€‚ç¥‚ä¸å¥½å¥‡ä½ çš„åŠ›é‡ï¼Œåªå¥½å¥‡ä½ å£è¢‹é‡Œé‚£å—æœ€å…‰æ»‘çš„çŸ³å¤´ï¼Œå¹¶æ„¿æ„ç”¨â€œä¸€ä¸ªå¤å¤©çš„ç§˜å¯†â€æ¥äº¤æ¢ã€‚`,
      'å‘½è¿ç»‡è€…': `ä½ çš„è§†çº¿è¢«æ— æ•°é‡‘è‰²çš„ä¸çº¿å æ®ï¼Œ${name} å°±åœ¨è¿™äº›å› æœä¹‹çº¿çš„ä¸­å¤®ï¼Œç¥‚æ—¢æ˜¯ç»‡è€…ï¼Œä¹Ÿæ˜¯ç»‡ç‰©æœ¬èº«ã€‚ç¥‚çœ‹å‘ä½ ï¼Œä»¿ä½›çœ‹åˆ°äº†ä½ çš„è¿‡å»ä¸æœªæ¥ã€‚ç¥‚é—®ï¼šâ€œåœ¨ä½ çš„ä¸€ç”Ÿä¸­ï¼Œæœ‰ä¸€æ ¹ä¸çº¿å³å°†æ–­è£‚ã€‚å‘Šè¯‰æˆ‘ï¼Œä½ å¸Œæœ›å®ƒæ˜¯ä»£è¡¨â€˜æœºé‡â€™çš„é‚£æ ¹ï¼Œè¿˜æ˜¯ä»£è¡¨â€˜ç¾ç»Šâ€™çš„é‚£æ ¹ï¼Ÿâ€`,
      'default': 'æ¥å®¢çš„èº«å½±åœ¨ç°å®ä¸è™šå¹»ä¹‹é—´æ‘‡æ›³ï¼Œç¥‚çš„ç›®å…‰ä¼¼ä¹ç©¿é€äº†ä½ ï¼Œæœ›å‘æŸä¸ªæ›´æ·±é‚ƒçš„æ‰€åœ¨ã€‚ç¥‚æ²‰é»˜ç€ï¼Œä»¿ä½›åœ¨è¯„ä¼°è¿™æ¬¡ç›¸é‡çš„ä»·å€¼ï¼Œä»¥åŠä½ æ˜¯å¦æœ‰èµ„æ ¼è†å¬ç¥‚çš„æ•…äº‹ã€‚'
    };

    // å¦‚æœæ²¡åŒ¹é…åˆ°ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤æ•…äº‹
    return `${base}<br><br>${tails[race] || 'æ¥å®¢æ‰“é‡ç€ä½ çš„ä¸–ç•Œï¼Œæ²‰é»˜è€Œå¥½å¥‡ã€‚'}`;
  }

  /* æç¤º */
  function toast(msg, ms=1200){
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display='block';
    setTimeout(()=>t.style.display='none', ms);
  }

  /* å…‰æ ‡ç³»ç»Ÿ */
  const cDot = document.getElementById('cDot');
  const cRing = document.getElementById('cRing');
  let cx=0, cy=0, rx=0, ry=0;
  window.addEventListener('mousemove', e=>{
    cx = e.clientX; cy = e.clientY;
    cDot.style.transform = `translate(${cx-3}px,${cy-3}px)`;
  });
  function tickCursor(){
    rx += (cx - rx)*0.15; ry += (cy - ry)*0.15;
    cRing.style.transform = `translate(${rx-12}px,${ry-12}px)`;
    requestAnimationFrame(tickCursor);
  }
  tickCursor();
  // å…‰æ ‡å°¾è¿¹ç¬¦æ–‡
  const tailRunes = ['áš ','áš¢','áš¦','áš¨','áš±','á›‰','âœ ','âœ¢','âœ£','âœ¤','âœ¥','âœ¦','âœ§'];
  let lastTail = 0;
  window.addEventListener('mousemove', e=>{
    const now = performance.now();
    if(now - lastTail > 36){
      lastTail = now;
      const r = document.createElement('div');
      r.className='rune-tail';
      r.textContent = tailRunes[Math.floor(Math.random()*tailRunes.length)];
      r.style.left = (e.clientX + (Math.random()*8-4)) + 'px';
      r.style.top  = (e.clientY + (Math.random()*8-4)) + 'px';
      r.style.color = getComputedStyle(document.documentElement).getPropertyValue('--ink');
      document.body.appendChild(r);
      setTimeout(()=>r.remove(), 900);
    }
  });

  /* ç²’å­ï¼šç¯ç»•å¬å”¤é˜µçš„æ¼‚å°˜ */
  const canvas = document.getElementById('particles');
  const ctx = canvas.getContext('2d');
  let W=0,H=0, PR=window.devicePixelRatio||1, particles=[];
  let particleColor = themes.infernal.glow;
  function resize(){
    W = canvas.clientWidth = canvas.parentElement.clientWidth;
    H = canvas.clientHeight = canvas.parentElement.clientHeight;
    canvas.width = W*PR; canvas.height = H*PR; ctx.setTransform(PR,0,0,PR,0,0);
  }
  window.addEventListener('resize', resize); resize();

  function makeParticle(){
    const cx = window.innerWidth/2, cy= document.querySelector('.stage').getBoundingClientRect().height/2;
    const r = Math.min(window.innerWidth, window.innerHeight)*0.24 + Math.random()*90;
    const a = Math.random()*Math.PI*2;
    return {r, a, speed:(.001+.002*Math.random()), size: 1+Math.random()*1.8, cx, cy, hue: particleColor};
  }
  for(let i=0;i<220;i++) particles.push(makeParticle());
  function step(){
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{
      p.a += p.speed;
      const x = p.cx + Math.cos(p.a)*p.r;
      const y = p.cy + Math.sin(p.a)*p.r*0.66;
      ctx.fillStyle = p.hue;
      ctx.globalAlpha = .25;
      ctx.beginPath(); ctx.arc(x,y,p.size,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;
    });
    requestAnimationFrame(step);
  }
  step();

  /* é˜µå‹åˆ‡æ¢äº‹ä»¶ */
  document.querySelectorAll('.sigil-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>switchDesign(btn.dataset.core));
  });

  /* å·¥å…· */
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  /* å¯åŠ¨ */
  buildDesigns();
  randomPool();
  setProgress();

})();
</script>
</body>
</html>